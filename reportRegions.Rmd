---
date: "`r paste0('Report Date: ', Sys.Date())`"
output: 
  officedown::rdocx_document:
    reference_docx: template_officedown.docx
---

```{r setup, include=FALSE}
options(knitr.duplicate.label = 'allow')
options(tinytex.verbose = TRUE)

knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      error = TRUE,
                      cache = FALSE,
                      cache.comments = FALSE,
                      include = TRUE,
                      autodep = TRUE,
                      eval = TRUE)

library(readxl)
library(tidyverse)
library(lubridate)
library(ggplot2)
library(plotly)
library(scales)
library(zoo)
library(knitr)

load("report_region.RData")

```

*Cut to the email recipient field:*

**TO:**

`r if(unique(bc_region$REGION)=="Eastern Region"){email.address_ER}`
`r if(unique(bc_region$REGION)=="Northwest Region"){email.address_NWR}`
`r if(unique(bc_region$REGION)=="Western Region"){email.address_WR}`

**CC:**

`r email.address_cc`

*Cut to the email contents:*

Hello all,

Below is the statewide update for satellite imagery of cyanobacteria in `r unique(bc_region$REGION)` waterbodies.

Please note in the report that:

*   The 7-Day Average Daily Maximum is now used for summarizing the cyanobacterial cell counts.       

*   The table includes all waterbodies with 7-Day Average Daily Maximum of cell counts above WHO thresholds (100,000 cells/mL) in the last 7 days.        

*   The time series plots include all resolvable waterbodies identified from EPAâ€™s CyAN project. The plots report both the daily average and daily maximum cell counts from April 1st through the present.       

*	All data presented in this report are provisional and subject to change. We suggest examining additional imagery from Sentinel 2 (https://www.sentinel-hub.com/explore/sentinelplayground/) or following up with site visits if necessary.    

Cheers!

*DELETE ABOVE AFTER CUT AND PASTE*

---
title: "`r paste0("CyAN Update (2021-04-01 - ", max(dta2$Date), ") for ",r)`"
---

Attn: `r knitr::combine_words(unique(sort(bc_region$STAFF)))`

---------------------------------------------------------------------------------------------------------------------

<!---BLOCK_LANDSCAPE_START--->

```{r table, echo=FALSE, results = 'asis'}

if(num>10){
  
  knitr::kable(tbl.7dmdm[1:num,], caption = caption_2)
  
} else {
  
  numb <- nrow(tbl.7dmdm[which(!tbl.7dmdm$`7-Day Average Daily Maximum (cells/mL)` == "Non-detect"),])
  
  if(num == numb){
    
    knitr::kable(tbl.7dmdm[1:num,], caption = caption_2)
    
  } else {
    
    knitr::kable(tbl.7dmdm[1:numb,], caption = caption_3)
  }
  
}
```

---------------------------------------------------------------------------------------------------------------------

`r paste0("Figures: Time series plots of daily maximums and daily means of cyanobacteria abundance (cells/mL) of the waterbodies during 2021-04-01 and ", as.Date(max(dta2$Date)), " in the ", r, ".")`

```{r ggplot, fig.width=10, fig.height=5, echo=FALSE}

for(i in gnisidname) {
  
  dta.plot <- dta %>% dplyr::filter(as.Date(Date) >= as.Date("2021-04-01"))
  
  plot <- ggplot(subset(dta.plot, dta.plot$GNISIDNAME == i),
                 aes(x=as.Date(Date), 
                     y=`Cyanobacteria (cells/mL)`,
                     group=`Summary Statistics`,
                     color=`Summary Statistics`)) +
    geom_line(size=1.5) +
    geom_point(color="black", alpha=0.3, size=3) +
    xlab("Date") +
    scale_x_date(date_labels = "%b-%d",
                 date_breaks = "week") +
    ylab("Cyanobacteria (cells/mL)") +
    #scale_y_continuous(labels = comma) +
    scale_y_continuous(trans = log10_trans(),
                       breaks = trans_breaks("log10", function(x) 10^x),
                       labels = trans_format("log10", math_format(10^.x))) +
    geom_hline(yintercept=100000,linetype="dashed",color="red",size=1.5) +
    annotate("text", as.Date(min(dta.plot$Date)), 100000, vjust = 1, hjust = 0,  label = "WHO Guideline") +
    ggtitle(i) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 10),
          axis.text.y = element_text(size = 10),
          axis.title.x = element_text(size = 12),
          axis.title.y = element_text(size = 12),
          plot.title = element_text(size=15))
  
  print(plot)
  
}

```

<!---BLOCK_LANDSCAPE_STOP--->