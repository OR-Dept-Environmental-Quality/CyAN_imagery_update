---
title: "CyAN Data and Imagery of Cyanobacteria in Oregon Lakes and Reservoirs"
date: "`r paste0('Report Date: ', Sys.Date())`"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
options(knitr.duplicate.label = 'allow',
        tinytex.verbose = TRUE)

knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      error = TRUE,
                      cache = FALSE,
                      cache.comments = FALSE,
                      include = TRUE,
                      autodep = TRUE,
                      eval = TRUE,
                      fig.keep='all')

library(readxl)
library(tidyverse)
library(lubridate)
library(ggplot2)
library(plotly)
library(scales)
library(zoo)
library(knitr)
library(magick)

load("report.RData")

```

<style type="text/css">

h1.title {
font-size: 40px;
text-align: left;
}
h4.date { /* Header 4 - and the author and data headers use this too  */
font-size: 20px;
text-align: center;
}
body{
font-size: 16px;
}
</style>

<br>

<p style="text-align: center; font-size: 32px;">Update for `r paste0(as.Date(max(dta2$Date))-7," - ", max(dta2$Date))`</p>

<br>

<p style="text-align: center; font-size: 32px;">Introduction</p>

This report provides a statewide update for satellite imagery estimates of cyanobacteria in Oregon waterbodies. We update the report weekly during the HABs season from March to October. Please note that:

*   The 7-Day Average Daily Maximum is used for summarizing the cyanobacterial abundance.       

*   The table includes all waterbodies with 7-Day Average Daily Maximum of cyanobacterial abundance above the World Health Organization (WHO) guideline value (100,000 cells/mL) for moderate probability of adverse health effects in the past 7 days. Potential health risks for the possible exposure through recreational activities, such as contact, ingestion and inhalation, during cyanobacterial abundance above this guideline level include skin irritations and gastrointestinal illness ([WHO 2003][WHO2003]).  

[WHO2003]: https://apps.who.int/iris/bitstream/handle/10665/42591/9241545801.pdf?sequence=1&isAllowed=y       

*   The time series plots include all resolvable waterbodies identified from EPAâ€™s CyAN project. The plots report both the daily average and daily maximum abundance from April 1st through the present.       

*   The satellite imageries ...

*   All data presented in this report are provisional and subject to change. Estimates of cyanobacterial abundance may be skewed by cloud cover, ice cover, sun glint, water surface roughness, dry lake beds, algal mats and shoreline effects. We suggest examining additional imagery from the [Sentinel 2 website][S2], visiting [OHA's current cyanobacteria advisory website][OHA], or following up with site visits to confirm on the ground conditions.    

[S2]: https://www.sentinel-hub.com/explore/sentinelplayground/
[OHA]: https://www.oregon.gov/oha/ph/healthyenvironments/recreation/harmfulalgaeblooms/pages/blue-greenalgaeadvisories.aspx

<br>

<p style="text-align: center; font-size: 32px;">Table</p>

```{r table, echo=FALSE, results = 'asis'}

knitr::kable(tbl.7dmdm[1:num,], caption = caption.or)

```

<br>

<p style="text-align: center; font-size: 32px;">Time Series Plots and Satellite Imageries</p>

**Time series plots** of daily maximums and daily means of cyanobacterial abundance (cells/mL) of the waterbodies during 2021-04-01 and `r as.Date(max(dta2$Date))`. Red dashed line: WHO RUV Guideline - World Health Organization Recreational Use Value Guideline for moderate probability of adverse health effects, which is 100,000 cyanobacterial cells/mL.

**Satellite imageries** of daily means of cyanobacterial abundance (cells/mL) of the waterbodies during the last 7 days from `r as.Date(max(dta2$Date))-7` to `r as.Date(max(dta2$Date))`.


```{r ggplot, fig.width=10, fig.height=5, results='asis', cache=FALSE, eval=TRUE, echo=FALSE}

# test: i <- "Odell Lake_01147159"

for(i in gnisidname) {
  
  dta.plot <- dta %>% dplyr::filter(as.Date(Date) >= as.Date("2021-04-01"))
  
  plot <- ggplot(subset(dta.plot, dta.plot$GNISIDNAME == i),
                 aes(x=as.Date(Date), 
                     y=`Cyanobacteria (cells/mL)`,
                     group=`Summary Statistics`,
                     color=`Summary Statistics`)) +
    geom_line(size=1.5) +
    geom_point(color="black", alpha=0.3, size=3) +
    xlab("Date") +
    scale_x_date(date_labels = "%b-%d",
                 date_breaks = "week",
                 limits = as.Date(c("2021-04-01",as.character(as.Date(max(dta2$Date)))))) +
    ylab("Cyanobacteria (cells/mL)") +
    #scale_y_continuous(labels = comma) +
    scale_y_continuous(trans = log10_trans(),
                       breaks = trans_breaks("log10", function(x) 10^x),
                       labels = trans_format("log10", math_format(10^.x))) +
    geom_hline(yintercept=100000,linetype="dashed",color="red",size=1.5) +
    annotate("text", as.Date(min(dta.plot$Date)), 100000, vjust = 1, hjust = 0,  label = "WHO RUV Guideline") +
    ggtitle(i) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 10),
          axis.text.y = element_text(size = 10),
          axis.title.x = element_text(size = 12),
          axis.title.y = element_text(size = 12),
          plot.title = element_text(size=15))
  
  print(plot)
  
  image <- paste0("./Report_Images/",i,".png")
  cat("![](",image,")")
  
}

```

<br>
<br>

<p style="text-align: center; font-size: 30px;">Contact</p>
<p style="text-align: center; font-size: 16px; line-height: 0.8;">The report is provided by Oregon DEQ Watershed Management.</p>     
<p style="text-align: center; font-size: 16px; line-height: 0.8;">For more information on this report, please contact</p>       
<p style="text-align: center; font-size: 16px; line-height: 0.8;">Dan Sobota, dan.sobota@deq.oregon.gov</p>       
<p style="text-align: center; font-size: 16px; line-height: 0.8;">Erin Costello, erin.costello@deq.oregon.gov</p>
<p style="text-align: center; font-size: 16px; line-height: 0.8;">Yuan Grund, yuan.grund@deq.oregon.gov</p>

<br>
<br>

