---
date: "`r paste0('Report Date: ', Sys.Date())`"
output: 
  officedown::rdocx_document:
    reference_docx: template_officedown.docx
---

```{r setup, include=FALSE}
options(knitr.duplicate.label = 'allow')
options(tinytex.verbose = TRUE)

knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      error = TRUE,
                      cache = FALSE,
                      cache.comments = FALSE,
                      include = TRUE,
                      autodep = TRUE,
                      eval = TRUE)

library(readxl)
library(tidyverse)
library(lubridate)
library(ggplot2)
library(plotly)
library(scales)
library(zoo)
library(knitr)

load("report.RData")

```

*------Cut to the email recipient field:------------------------------------*

**TO:**

`r email.address_OR`

**CC:**

`r email.address_cc`

*------Cut to the email contents:------------------------------------*

Hello all,

Below is the statewide update for satellite imagery estimates of cyanobacteria in Oregon waterbodies.  

Please note that:

*   The 7-Day Average Daily Maximum is used for summarizing the cyanobacterial abundance.       

*   The table includes all waterbodies with 7-Day Average Daily Maximum of cyanobacterial abundance above the World Health Organization (WHO) guideline value (100,000 cells/mL) for moderate probability of adverse health effects in the past 7 days. Potential health risks for the possible exposure through recreational activities, such as contact, ingestion and inhalation, during cyanobacterial abundance above this guideline level include skin irritations and gastrointestinal illness ([WHO 2003][WHO2003]).  

[WHO2003]: https://apps.who.int/iris/bitstream/handle/10665/42591/9241545801.pdf?sequence=1&isAllowed=y       

*   The time series plots include all resolvable waterbodies identified from EPAâ€™s CyAN project. The plots report both the daily average and daily maximum abundance from April 1st through the present.       

*   All data presented in this report are provisional and subject to change. Estimates of cyanobacterial abundance may be skewed by cloud cover, ice cover, sun glint, water surface roughness, dry lake beds, algal mats and shoreline effects. We suggest examining additional imagery from Sentinel 2 (https://www.sentinel-hub.com/explore/sentinelplayground/) or following up with site visits to confirm on the ground conditions.       

Cheers!

*------DELETE ABOVE AFTER CUT AND PASTE------*

---
title: "`r paste0("CyAN Update (2021-04-01 - ", max(dta2$Date), ")")`"
---

<!---BLOCK_LANDSCAPE_START--->

```{r table, echo=FALSE, results = 'asis'}

knitr::kable(tbl.7dmdm[1:num,], caption = caption.or)


```

`r paste0("Figures: Time series plots of daily maximums and daily means of cyanobacterial abundance (cells/mL) of the waterbodies during 2021-04-01 and ", as.Date(max(dta2$Date)), ". Red dashed line: WHO RUV Guideline - World Health Organization Recreational Use Value Guideline for moderate probability of adverse health effects, which is 100,000 cyanobacterial cells/mL.")`

```{r ggplot, fig.width=10, fig.height=5, echo=FALSE}

# test: i <- "Odell Lake_01147159"

for(i in gnisidname) {
  
  dta.plot <- dta %>% dplyr::filter(as.Date(Date) >= as.Date("2021-04-01"))
  
  plot <- ggplot(subset(dta.plot, dta.plot$GNISIDNAME == i),
                 aes(x=as.Date(Date), 
                     y=`Cyanobacteria (cells/mL)`,
                     group=`Summary Statistics`,
                     color=`Summary Statistics`)) +
    geom_line(size=1.5) +
    geom_point(color="black", alpha=0.3, size=3) +
    xlab("Date") +
    scale_x_date(date_labels = "%b-%d",
                 date_breaks = "week") +
    ylab("Cyanobacteria (cells/mL)") +
    #scale_y_continuous(labels = comma) +
    scale_y_continuous(trans = log10_trans(),
                       breaks = trans_breaks("log10", function(x) 10^x),
                       labels = trans_format("log10", math_format(10^.x))) +
    geom_hline(yintercept=100000,linetype="dashed",color="red",size=1.5) +
    annotate("text", as.Date(min(dta.plot$Date)), 100000, vjust = 1, hjust = 0,  label = "WHO RUV Guideline") +
    ggtitle(i) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 10),
          axis.text.y = element_text(size = 10),
          axis.title.x = element_text(size = 12),
          axis.title.y = element_text(size = 12),
          plot.title = element_text(size=15))
  
  print(plot)
  
}

```

<!---BLOCK_LANDSCAPE_STOP--->

